trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: 'bicep-deployment-secrets'
  - name: serviceConnection
    value: 'AzureServiceConnection'

stages:
  - stage: Deploy
    displayName: 'Deploy SQL Server VM'
    jobs:
      - deployment: DeployVM
        environment: 'Production'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                  displayName: 'Checkout Code'
                
                # FIXED: Use inlineScript instead of scriptPath
                - task: AzureCLI@2
                  displayName: 'Install Bicep'
                  inputs:
                    azureSubscription: '$(serviceConnection)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'  # ← ADD THIS
                    inlineScript: |                 # ← USE THIS
                      echo "Installing Bicep CLI..."
                      az bicep install
                      echo "Bicep version:"
                      az bicep version
                
                # FIXED: Same fix for deploy task
                - task: AzureCLI@2
                  displayName: 'Deploy Virtual Machine'
                  inputs:
                    azureSubscription: '$(serviceConnection)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'  # ← ADD THIS
                    inlineScript: |                 # ← USE THIS
                      echo "=========================================="
                      echo "Deploying SQL Server VM"
                      echo "=========================================="
                      echo "Resource Group: $(RESOURCE_GROUP_NAME)"
                      echo "VM Name: $(VM_NAME)"
                      echo "Location: $(LOCATION)"
                      echo "Key Vault: $(KEY_VAULT_NAME)"
                      echo ""
                      
                      # Deploy VM
                      az deployment group create \
                        --resource-group $(RESOURCE_GROUP_NAME) \
                        --template-file bicep/main.bicep \
                        --parameters @bicep/main.bicepparam \
                        --parameters vnetResourceId="$(VNET_RESOURCE_ID)" \
                        --parameters nsgResourceId="$(NSG_RESOURCE_ID)" \
                        --parameters keyVaultName="$(KEY_VAULT_NAME)" \
                        --parameters location="$(LOCATION)" \
                        --name "vm-deploy-$(Build.BuildId)"
                      
                      if [ $? -eq 0 ]; then
                        echo ""
                        echo "✅ VM deployment completed successfully!"
                        echo ""
                        
                        # Show outputs
                        echo "Deployment Outputs:"
                        az deployment group show \
                          --resource-group $(RESOURCE_GROUP_NAME) \
                          --name "vm-deploy-$(Build.BuildId)" \
                          --query properties.outputs \
                          -o json
                      else
                        echo "❌ VM deployment failed"
                        exit 1
                      fi
                
                - task: PowerShell@2
                  displayName: 'Display Connection Info'
                  inputs:
                    targetType: 'inline'
                    script: |
                      Write-Host ""
                      Write-Host "=========================================="
                      Write-Host "DEPLOYMENT COMPLETE!"
                      Write-Host "=========================================="
                      Write-Host ""
                      Write-Host "VM: $(VM_NAME)"
                      Write-Host "Admin: $(ADMIN_USERNAME)"
                      Write-Host "Key Vault: $(KEY_VAULT_NAME)"
                      Write-Host ""
                      Write-Host "To retrieve password:"
                      Write-Host "az keyvault secret show \"
                      Write-Host "  --vault-name $(KEY_VAULT_NAME) \"
                      Write-Host "  --name vmAdminPassword \"
                      Write-Host "  --query value -o tsv"