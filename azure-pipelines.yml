trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: 'bicep-deployment-secrets'
  - name: serviceConnection
    value: 'AzureServiceConnection'

stages:
  - stage: Deploy
    displayName: 'Deploy SQL Server VM'
    jobs:
      - deployment: DeployVM
        environment: 'Production'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                  displayName: 'Checkout Code'
                
                - task: AzureCLI@2
                  displayName: 'Install Bicep CLI'
                  inputs:
                    azureSubscription: '$(serviceConnection)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "Installing Bicep CLI..."
                      az bicep install
                      echo "Bicep version:"
                      az bicep version
                
                # Get password from Key Vault
                - task: AzureCLI@2
                  displayName: 'Get Password from Key Vault'
                  inputs:
                    azureSubscription: '$(serviceConnection)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "Retrieving password from Key Vault..."
                      ADMIN_PASSWORD=$(az keyvault secret show \
                        --vault-name $(KEY_VAULT_NAME) \
                        --name vmAdminPassword \
                        --query value -o tsv)
                      
                      # Store as secret pipeline variable
                      echo "##vso[task.setvariable variable=ADMIN_PASSWORD;issecret=true]$ADMIN_PASSWORD"
                      echo "✅ Password retrieved (not shown for security)"
                
                # Deploy VM with password parameter
                - task: AzureCLI@2
                  displayName: 'Deploy Virtual Machine'
                  inputs:
                    azureSubscription: '$(serviceConnection)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "=========================================="
                      echo "Deploying SQL Server VM"
                      echo "=========================================="
                      echo "Resource Group: $(RESOURCE_GROUP_NAME)"
                      echo "VM Name: $(VM_NAME)"
                      echo "Location: $(LOCATION)"
                      echo "Key Vault: $(KEY_VAULT_NAME)"
                      echo ""
                      
                      # Deploy VM with password parameter
                      az deployment group create \
                        --resource-group $(RESOURCE_GROUP_NAME) \
                        --template-file bicep/main.bicep \
                        --parameters vmName="$(VM_NAME)" \
                        --parameters adminUsername="$(ADMIN_USERNAME)" \
                        --parameters adminPassword="$(ADMIN_PASSWORD)" \
                        --parameters vmSize="Standard_B2s_v2" \
                        --parameters location="$(LOCATION)" \
                        --parameters subnetName="misc" \
                        --parameters vnetResourceId="$(VNET_RESOURCE_ID)" \
                        --parameters nsgResourceId="$(NSG_RESOURCE_ID)" \
                        --parameters keyVaultName="$(KEY_VAULT_NAME)" \
                        --name "vm-deploy-$(Build.BuildId)"
                      
                      if [ $? -eq 0 ]; then
                        echo ""
                        echo "✅ VM deployment completed successfully!"
                      else
                        echo "❌ VM deployment failed"
                        exit 1
                      fi
                
                - task: PowerShell@2
                  displayName: 'Display Connection Information'
                  inputs:
                    targetType: 'inline'
                    script: |
                      Write-Host ""
                      Write-Host "=========================================="
                      Write-Host "DEPLOYMENT COMPLETE!"
                      Write-Host "=========================================="
                      Write-Host ""
                      Write-Host "VM: $(VM_NAME)"
                      Write-Host "Admin: $(ADMIN_USERNAME)"
                      Write-Host "Password: Retrieved from Key Vault"
                      Write-Host ""
                      Write-Host "JIT Configuration Required:"
                      Write-Host "1. Enable Microsoft Defender for Servers"
                      Write-Host "2. Configure JIT access for port 3389"