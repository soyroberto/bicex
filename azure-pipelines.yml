# ============================================================================
# Azure DevOps Pipeline for Bicep Deployment
# Roberto
# Version: 1.0.0
# ============================================================================

trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  # Variable group containing secrets
  - group: 'bicep-deployment-secrets'
  
  # Pipeline variables
  - name: serviceConnection
    value: 'AzureServiceConnection'
  - name: deploymentMode
    value: 'Incremental'
  - name: location
    value: 'australiaeast'

stages:
  # STAGE 1: Validate
  - stage: Validate
    displayName: 'Validate Bicep'
    jobs:
      - job: Validate
        steps:
          - checkout: self
          
          - task: AzureCLI@2
            displayName: 'Validate Bicep Templates'
            inputs:
              azureSubscription: '$(serviceConnection)'
              scriptType: 'bash'
              inlineScript: |
                echo "Installing Bicep CLI..."
                az bicep install
                
                echo "Validating Bicep files..."
                az bicep build --file bicep/main.bicep --stdout > /dev/null
                echo "âœ… Bicep validation passed"

  # STAGE 2: Deploy Key Vault (if needed)
  - stage: DeployKeyVault
    displayName: 'Deploy Key Vault'
    dependsOn: Validate
    condition: succeeded()
    jobs:
      - deployment: DeployKeyVault
        environment: 'Production'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                
                - task: AzureCLI@2
                  displayName: 'Get Current User Principal ID'
                  inputs:
                    azureSubscription: '$(serviceConnection)'
                    scriptType: 'bash'
                    inlineScript: |
                      echo "Getting current user principal ID..."
                      PRINCIPAL_ID=$(az ad signed-in-user show --query id -o tsv)
                      echo "##vso[task.setvariable variable=PRINCIPAL_ID;issecret=true]$PRINCIPAL_ID"
                
                - task: AzureCLI@2
                  displayName: 'Deploy Key Vault'
                  inputs:
                    azureSubscription: '$(serviceConnection)'
                    scriptType: 'bash'
                    inlineScript: |
                      echo "Deploying Key Vault..."
                      
                      az deployment group create \
                        --resource-group $(RESOURCE_GROUP_NAME) \
                        --template-file bicep/keyvault.bicep \
                        --parameters keyVaultName=$(KEY_VAULT_NAME) \
                        --parameters location=$(location) \
                        --parameters adminUsername=$(ADMIN_USERNAME) \
                        --parameters principalId=$(PRINCIPAL_ID) \
                        --name "kv-deploy-$(Build.BuildId)"
                      
                      echo "âœ… Key Vault deployed"

  # STAGE 3: Deploy VM
  - stage: DeployVM
    displayName: 'Deploy Virtual Machine'
    dependsOn: DeployKeyVault
    condition: succeeded()
    jobs:
      - deployment: DeployVM
        environment: 'Production'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                
                - task: AzureCLI@2
                  displayName: 'Deploy VM with SQL Server'
                  inputs:
                    azureSubscription: '$(serviceConnection)'
                    scriptType: 'bash'
                    inlineScript: |
                      echo "Deploying Virtual Machine..."
                      
                      az deployment group create \
                        --resource-group $(RESOURCE_GROUP_NAME) \
                        --template-file bicep/main.bicep \
                        --parameters @bicep/main.bicepparam \
                        --parameters vnetResourceId=$(VNET_RESOURCE_ID) \
                        --parameters nsgResourceId=$(NSG_RESOURCE_ID) \
                        --parameters keyVaultName=$(KEY_VAULT_NAME) \
                        --parameters location=$(location) \
                        --name "vm-deploy-$(Build.BuildId)"
                      
                      echo "âœ… VM deployment completed"

  # STAGE 4: Configure JIT
  - stage: ConfigureJIT
    displayName: 'Configure JIT Access'
    dependsOn: DeployVM
    condition: succeeded()
    jobs:
      - job: ConfigureJIT
        steps:
          - checkout: self
          
          - task: PowerShell@2
            displayName: 'Configure JIT Access'
            inputs:
              targetType: 'inline'
              script: |
                Write-Host "Configuring JIT Access for VM..."
                
                # This requires Microsoft Defender for Servers Plan 2
                # Manual configuration steps displayed
                Write-Host "`nðŸ“‹ MANUAL JIT CONFIGURATION STEPS:"
                Write-Host "======================================"
                Write-Host "1. Go to Azure Portal â†’ Microsoft Defender for Cloud"
                Write-Host "2. Navigate to Workload protections â†’ Just-in-time VM access"
                Write-Host "3. Find VM: $(VM_NAME)"
                Write-Host "4. Click 'Enable JIT on 1 VM'"
                Write-Host "5. Configure RDP port 3389"
                Write-Host "6. Set max request time: 3 hours"
                Write-Host "7. Save configuration"
                Write-Host "`nNote: Requires Microsoft Defender for Servers Plan 2"